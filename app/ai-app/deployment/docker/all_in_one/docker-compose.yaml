services:
  postgres-db:
    container_name: kdcube-postgres
    image: pgvector/pgvector:pg16
    env_file:
      - path: ./.env.backend
        required: false
    restart: unless-stopped
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - kdcube-internal
    ports:
      - "127.0.0.1:5432:5444"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-setup:
    image: kdcube-postgres-setup:latest
    container_name: kdcube-postgres-setup
    build:
      context: ../../..
      dockerfile: deployment/docker/all_in_one/Dockerfile_PostgresSetup
    env_file:
      - path: ./.env.backend
        required: false
    environment:
      - POSTGRES_HOST=postgres-db
    depends_on:
      postgres-db:
        condition: service_healthy
    networks:
      - kdcube-internal
    restart: "no"

  redis:
    container_name: kdcube-redis
    image: redis:latest
    env_file:
      - path: ./.env.backend
        required: false
    command: /bin/sh -c "redis-server --requirepass $$REDIS_PASSWORD"
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    networks:
      - kdcube-internal
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  neo4j:
    image: neo4j:5
    container_name: kdcube-neo4j
    env_file:
      - path: ./.env.backend
        required: false
    environment:
      NEO4J_AUTH: "${N4J_USER:-neo4j}/${N4J_PASSWORD:-neo4jpassword}"
      NEO4J_server_memory_pagecache_size: ${N4J_PAGECACHE:-1G}
      NEO4J_server_memory_heap_initial__size: ${N4J_HEAP_INITIAL:-512m}
      NEO4J_server_memory_heap_max__size: ${N4J_HEAP_MAX:-1G}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
    volumes:
      - ./data/neo4j/data:/data
      - ./data/neo4j/logs:/logs
      - ./data/neo4j/plugins:/plugins
      - ./data/neo4j/import:/var/lib/neo4j/import
    healthcheck:
      # Uses container env (note the $$ for compose escaping)
      test: ["CMD-SHELL", "cypher-shell -a bolt://localhost:7687 -u $$N4J_USER -p $$N4J_PASSWORD 'RETURN 1' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
    networks:
      - kdcube-internal
    # Expose if you want to use Neo4j Browser locallly
    ports:
      - "127.0.0.1:7474:7474" # HTTP (Neo4j Browser)
      - "127.0.0.1:7687:7687" # Bolt

  clamav:
    image: clamav/clamav:stable
    container_name: kdcube-clamav
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - kdcube-internal
    environment:
      - CLAMD_START=1
      - FRESHCLAM_CHECKS=24
    healthcheck:
      test: ["CMD-SHELL", "clamdscan --version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
    volumes:
      - ./data/clamav:/var/lib/clamav
    ports:
      - "127.0.0.1:3310:3310"

#  kb:
#    image: kdcube-kb:latest
#    container_name: kdcube-kb
#    build:
#      context: ../../..
#      dockerfile: deployment/docker/all_in_one/Dockerfile_KB
#    profiles:
#      - optional  # Not started by default
#    env_file:
#      - path: ./.env.backend
#        required: false
#    environment:
#      - REDIS_HOST=redis
#      - POSTGRES_HOST=postgres-db
#      - LOG_FILE_PREFIX=kb
#    volumes:
#      - ./data/kdcube-storage:/kdcube-storage
#      - ./data/exec-workspace:/exec-workspace
#      - ./logs/kb:/logs
#    depends_on:
#      postgres-setup:
#        condition: service_completed_successfully
#      redis:
#        condition: service_healthy
#    networks:
#      - kdcube-internal
#
#  dramatiq:
#    image: kdcube-dramatiq:latest
#    container_name: kdcube-dramatiq
#    build:
#      context: ../../..
#      dockerfile: deployment/docker/all_in_one/Dockerfile_Dramatiq
#    profiles:
#      - optional  # Not started by default
#    env_file:
#      - path: ./.env.backend
#        required: false
#    environment:
#      - REDIS_HOST=redis
#      - POSTGRES_HOST=postgres-db
#      - LOG_FILE_PREFIX=dramatiq
#    volumes:
#      - ./data/kdcube-storage:/kdcube-storage
#      - ./logs/dramatiq:/logs
#    depends_on:
#      postgres-setup:
#        condition: service_completed_successfully
#      redis:
#        condition: service_healthy
#      kb:
#        condition: service_started
#    networks:
#      - kdcube-internal

  chat:
    image: kdcube-chat:latest
    container_name: kdcube-chat
    build:
      context: ../../..
      dockerfile: deployment/docker/all_in_one/Dockerfile_Chat
    env_file:
      - path: ./.env.backend
        required: false
    environment:
      - REDIS_HOST=redis
      - POSTGRES_HOST=postgres-db
      - APP_NEO4J_URI=bolt://neo4j:7687
      - CLAMAV_HOST=clamav
      - CLAMAV_PORT=3310
      - LOG_FILE_PREFIX=chat
      - HOST_KB_STORAGE_PATH=${HOST_KB_STORAGE_PATH}
      - HOST_BUNDLES_PATH=${HOST_BUNDLES_PATH}
      - HOST_EXEC_WORKSPACE_PATH=${HOST_EXEC_WORKSPACE_PATH}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/kdcube-storage:/kdcube-storage
      - ./data/exec-workspace:/exec-workspace
      - ./logs/chat:/logs
      - type: bind
        source: ${HOST_BUNDLES_PATH?}           # host root with all bundles
        target: ${AGENTIC_BUNDLES_ROOT?}       # e.g. /bundles inside the container
      - type: bind
        source: ${HOME}/.aws
        target: /home/appuser/.aws
        read_only: true
    depends_on:
      postgres-setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      clamav:
        condition: service_healthy
    networks:
      - kdcube-internal
    ports:
      - "127.0.0.1:8000:8010"

  web-ui:
    image: kdcube-web-ui:latest
    container_name: kdcube-web-ui
    build:
      context: ${UI_BUILD_CONTEXT}
      dockerfile: ${UI_DOCKERFILE_PATH}
      args:
        - UI_SOURCE_PATH=${UI_SOURCE_PATH}
        - UI_ENV_BUILD_RELATIVE=${UI_ENV_BUILD_RELATIVE}
        - NGINX_CONFIG_FILE_PATH=${NGINX_UI_CONFIG_FILE_PATH}
    env_file:
      - path: ${UI_ENV_FILE_PATH}
        required: false
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    depends_on:
      chat:
        condition: service_started
    networks:
      - kdcube-internal

  web-proxy:
    image: kdcube-web-proxy:latest
    container_name: kdcube-web-proxy
    build:
      context: ${PROXY_BUILD_CONTEXT}
      dockerfile: ${PROXY_DOCKERFILE_PATH}
      args:
        - NGINX_CONFIG_FILE_PATH=${NGINX_PROXY_CONFIG_FILE_PATH}
    restart: unless-stopped
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./nginx/webroot:/var/www/letsencrypt
    depends_on:
      chat:
        condition: service_started
      web-ui:
        condition: service_started
    networks:
      - kdcube-external
      - kdcube-internal
    ports:
      - "80:80"
      - "443:443"

networks:
  kdcube-external:
    driver: bridge
  kdcube-internal:
    driver: bridge

#volumes:
#  redis-data:
#  postgres-data:
#  neo4j-data:
#  neo4j-logs:
#  neo4j-plugins:
#  neo4j-import:
#  clamav-db: