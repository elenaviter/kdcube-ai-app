# with_context (Minimal Bundle)

This bundle demonstrates a **minimal, no‑solver** chatbot that still uses:
- conversation context search
- context reconciler
- multichannel streaming (thinking/answer/followup)
- turn summary + timing step

## Workflow Schema (high‑level)

```
[Ingress]
  └─ receive user text + attachments

[Turn Init]
  └─ construct scratchpad + turn log
  └─ summarize & persist attachment summaries

[Retrospective Context v1]
  └─ last N turns (compressed) + current turn log

[Gate]
  └─ minimal gate → ctx_retrieval_queries only
  └─ emit gate step + thinking deltas

[Context Search]
  └─ search via ConvIndex using gate queries
  └─ collect hit turn_ids + queries

[Retrospective Context v2]
  └─ rebuild retrospective view with hit hints

[Ctx Reconciler]
  └─ pick turn_ids (materialize set) + prefs/facts
  └─ persist user message (index)

[Materialize Turns]
  └─ load selected turn logs → ContextBundle
  └─ reconcile citations → sources_pool

[Answer Generation]
  └─ multichannel stream via versatile streamer
     - channel:thinking → marker=thinking
     - channel:answer   → marker=answer
     - channel:followup → JSON {followups:[...]}
  └─ emit answer step + followups event

[Turn Summary]
  └─ summarize turn (stream_turn_summary)

[Finish Turn]
  └─ persist turn log + artifacts
  └─ emit timings step
```

## Key Guarantees

- **No solver** is invoked.
- Gate only emits context queries (custom GateOut).
- Followups are generated by the **final answer** channel (not the gate).
- Streaming uses `stream_with_channels` and requires the model to output strict channel tags.
- Attachments are handled by the platform’s attachment pipeline; multimodal policy is configured elsewhere.

## Files

- Entry: `entrypoint.py`
- Orchestrator: `orchestrator/workflow.py`
- Gate: `agents/gate.py`
- Final answer: `agents/final_answer_generator.py`

## Live update (local development)

Python caches imported modules, so editing code in place will not be picked up by running services.
Use a versioned path and update the registry instead.

Recommended flow:
1) Copy your bundle to a new path (e.g. `with_context_v2` or `with_context@2026-02-01-20-31`).
2) Update the bundle registry to point to the new `path`/`module`.
3) (Optional) Click **Cleanup old versions** in the AI Bundles dashboard to evict cached old code.

This keeps in-flight requests on the old version and routes new requests to the new version without restart.
